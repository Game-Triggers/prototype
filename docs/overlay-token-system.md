# Overlay Token Management System

## Overview

The Instreamly Clone platform uses a dual-token approach for overlay management to balance usability with tracking capabilities.

## Token Types

### 1. User Overlay Token (`overlayToken`)

- **Purpose**: Main overlay URL that streamers add to OBS/Streamlabs
- **Location**: Stored in `users` collection
- **URL Format**: `/api/overlay/{overlayToken}`
- **Regeneration**: Can be regenerated by streamers when needed
- **Usage**: Primary endpoint for overlay display in streaming software

### 2. Campaign Participation Token (`browserSourceToken`)

- **Purpose**: Unique tracking token for individual campaign analytics
- **Location**: Stored in `campaignparticipations` collection  
- **URL Format**: `/api/v1/overlay/{browserSourceToken}`
- **Generation**: Created automatically when joining a campaign
- **Uniqueness**: Each campaign participation has a unique token (enforced by database index)

## How It Works

### Overlay Display Flow

1. **Streamer Setup**: Streamer adds main overlay URL (`/api/overlay/{overlayToken}`) to OBS
2. **Token Lookup**: Overlay service finds user by `overlayToken`
3. **Campaign Selection**: Service finds all active campaign participations for the user
4. **Smart Rotation**: Service selects optimal campaign using rotation strategy
5. **Content Display**: Selected campaign content is displayed in overlay

### Token Regeneration

When a streamer regenerates their overlay token:

✅ **What Changes:**
- User's `overlayToken` is updated with new random value
- Main overlay URL changes to use new token
- Streamer must update browser source URL in streaming software

✅ **What Stays the Same:**
- All campaign participation tokens remain unchanged
- Campaign tracking continues to work normally
- Analytics and earnings tracking are unaffected
- All joined campaigns remain active

## Implementation Details

### Backend Service (`UsersService.regenerateOverlayToken`)

```typescript
async regenerateOverlayToken(userId: string): Promise<{ overlayToken: string }> {
  // Generate new user overlay token
  const newToken = this.generateOverlayToken();
  user.overlayToken = newToken;
  await user.save();
  
  // Campaign participation tokens are NOT updated (by design)
  // Each participation keeps its unique token for tracking
  
  return { overlayToken: user.overlayToken };
}
```

### Campaign Joining (`CampaignsService.joinCampaign`)

```typescript
async joinCampaign(joinCampaignDto: JoinCampaignDto): Promise<ICampaignParticipation> {
  // Each participation gets a unique tracking token
  const browserSourceToken = crypto
    .createHash('sha256')
    .update(`${streamerId}-${campaignId}-${Date.now()}`)
    .digest('hex');
    
  // This token is unique per participation for analytics
  const participation = new this.participationModel({
    // ... other fields
    browserSourceToken,
    browserSourceUrl: `/api/v1/overlay/${browserSourceToken}`,
  });
}
```

### Overlay Data Resolution (`OverlayService.getOverlayData`)

```typescript
async getOverlayData(token: string) {
  // Check if token is a user overlay token
  const user = await this.userModel.findOne({ overlayToken: token }).exec();
  
  if (user) {
    // Find all active participations for this user
    const participations = await this.participationModel
      .find({ streamerId: user._id, status: ParticipationStatus.ACTIVE })
      .exec();
      
    // Select optimal campaign using rotation strategy
    const selectedParticipation = await this.selectOptimalCampaign(participations);
    
    return { participation: selectedParticipation, campaign, overlaySettings };
  }
  
  // Fallback: check if token is an individual participation token
  const participation = await this.participationModel
    .findOne({ browserSourceToken: token })
    .exec();
}
```

## Database Schema

### Users Collection
```javascript
{
  _id: ObjectId,
  email: String,
  overlayToken: String, // Main overlay token for OBS
  overlaySettings: {
    position: String,
    size: String,
    opacity: Number,
    backgroundColor: String
  }
}
```

### Campaign Participations Collection
```javascript
{
  _id: ObjectId,
  campaignId: ObjectId,
  streamerId: ObjectId,
  status: String,
  browserSourceToken: String, // Unique per participation
  browserSourceUrl: String,
  impressions: Number,
  clicks: Number,
  // ... analytics fields
}
```

### Database Indexes
```javascript
// Ensures each participation has unique tracking token
campaignParticipations.createIndex({ browserSourceToken: 1 }, { unique: true });

// Ensures user can't join same campaign twice  
campaignParticipations.createIndex({ campaignId: 1, streamerId: 1 }, { unique: true });
```

## Benefits of This Design

1. **User-Friendly**: Streamers only need to set up one overlay URL in OBS
2. **Flexible**: Token regeneration doesn't break existing campaign relationships
3. **Trackable**: Each campaign participation has unique analytics tracking
4. **Scalable**: System can handle multiple campaigns per streamer efficiently
5. **Secure**: Tokens can be regenerated without losing campaign data
6. **Backwards Compatible**: Supports both user tokens and participation tokens

## Frontend Integration

### Overlay Settings Page
- Displays current overlay URL using user's `overlayToken`
- Provides regeneration button with clear warnings
- Shows success message with instructions to update OBS

### Campaign Management
- Campaign joining creates unique participation tokens automatically
- Campaign analytics use individual participation tokens for tracking
- Campaign leaving doesn't affect other participations

## Security Considerations

- Overlay tokens are cryptographically secure random strings
- Tokens are only accessible to authenticated users
- Token regeneration invalidates old tokens immediately
- Individual participation tokens provide audit trail for campaign performance

## Testing

Run the test suite to verify token regeneration:

```bash
node test-overlay-token-update.js
```

This validates that:
- User overlay tokens can be regenerated
- Campaign participation tokens remain unchanged
- Database constraints are respected
- System maintains data integrity

## Troubleshooting

### Common Issues

1. **"Invalid overlay token" error**: User needs to regenerate token and update OBS URL
2. **Campaigns not showing**: Check that user has active campaign participations
3. **Analytics not tracking**: Verify participation tokens are unique and valid
4. **Database constraint errors**: Ensure participation tokens don't conflict

### Debug Steps

1. Check user's `overlayToken` in database
2. Verify active participations exist for user
3. Test overlay URL directly in browser
4. Check campaign status and availability
5. Validate streaming software configuration
